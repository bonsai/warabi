<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Jelly Iridescent</title>
  <style>
    body { margin:0; overflow:hidden; background:#888; }
    canvas { display:block; }
    #access-denied {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.95);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    #debug-info {
      position: absolute;
      top: 10px;
      right: 10px;
      color: lime;
      font-family: monospace;
      font-size: 16px;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      pointer-events: none;
      z-index: 100;
    }
  </style>
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.171.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.171.0/examples/jsm/"
    }
  }
  </script>
  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  <!-- GIF.js -->
  <script src="gif.js"></script>
</head>
<body>
<div id="access-denied">
  <h1>⚠️ ACCESS RESTRICTED ⚠️</h1>
  <p>This experience is ONLY available at <strong>WARABI STATION</strong>.</p>
  <p id="location-status">Checking your location...</p>
</div>

<div id="debug-info">Initializing...</div>

<!-- Video Element for MediaPipe (Hidden) -->
<video id="input_video" style="display:none"></video>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { checkAccess } from './area-lock.js';
import { MediaPipeController } from './mediapipe.js';
import { JellyEffect } from './jelly-effect.js';

// Initialize Access Check
checkAccess();

const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 100);
camera.position.set(0, 0, 8);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.enableRotate = false; // 自転・公転させない（手動操作もロックした方が良いかもだが、一旦回転のみロック）
controls.enableZoom = false;
controls.enablePan = false;

// --------------------------------------------------------
// 背景（カメラ映像＋グレー＋荒く）
// --------------------------------------------------------
const videoElement = document.getElementById('input_video');
const videoTexture = new THREE.VideoTexture(videoElement);
videoTexture.colorSpace = THREE.SRGBColorSpace;

const bgGeometry = new THREE.PlaneGeometry(2, 2);
const bgMaterial = new THREE.ShaderMaterial({
  uniforms: {
    tDiffuse: { value: videoTexture },
    resolution: { value: new THREE.Vector2(innerWidth, innerHeight) }
  },
  vertexShader: `
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = vec4( position, 1.0 );
    }
  `,
  fragmentShader: `
    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    varying vec2 vUv;
    
    void main() {
      // 左右反転 (Mirror)
      vec2 uv = vec2(1.0 - vUv.x, vUv.y);

      // ピクセル化（より細かく）
      float pixelSize = 4.0; // 10.0 -> 4.0
      vec2 dxy = pixelSize / resolution;
      vec2 coord = floor(uv / dxy) * dxy;
      
      vec4 color = texture2D(tDiffuse, coord);
      
      // グレースケール & 暗くする (More Black)
      float gray = dot(color.rgb, vec3(0.299, 0.587, 0.114));
      gl_FragColor = vec4(vec3(gray * 0.05), 1.0); // 0.15 -> 0.05 (Darker)
    }
  `,
  depthTest: false,
  depthWrite: false
});
const bgMesh = new THREE.Mesh(bgGeometry, bgMaterial);
scene.add(bgMesh);

// --------------------------------------------------------
// 光
// --------------------------------------------------------
const light = new THREE.DirectionalLight(0xffffff, 3);
light.position.set(5, 8, 6);
scene.add(light);
scene.add(new THREE.AmbientLight(0xffffff, 0.5));

// --------------------------------------------------------
// ゼリー本体
// --------------------------------------------------------
const jellyEffect = new JellyEffect(20);
const jelly = jellyEffect.mesh;
jelly.position.set(0, 0, 0);
scene.add(jelly);

const material = jelly.material; // For compatibility if referenced elsewhere
const interactionUniforms = jellyEffect.uniforms;

// --------------------------------------------------------
// Finger Markers & MediaPipe
// --------------------------------------------------------
const mediaPipeController = new MediaPipeController(scene, camera, renderer, jelly, interactionUniforms);
mediaPipeController.start(videoElement);

// --------------------------------------------------------
// Animation Loop
// --------------------------------------------------------
let time = 0;
let lastTime = 0;
const fpsInterval = 1000 / 15; // 15 FPS

function animate(currentTime) {
  requestAnimationFrame(animate);
  
  const delta = currentTime - lastTime;
  if (delta > fpsInterval) {
    lastTime = currentTime - (delta % fpsInterval);
    
    time += 0.016 * (delta / 16.66); // 時間経過補正（概算）

    if (material.userData.shader) {
      // material.userData.shader.uniforms.time.value = time; // Managed by jellyEffect
      jellyEffect.update(time);
    }
    
    controls.update();
    renderer.render(scene, camera);
    
    // GIF Recording & Updates
    mediaPipeController.update(fpsInterval);
  }
}
animate(0);

// リサイズ対応
window.addEventListener('resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
  bgMaterial.uniforms.resolution.value.set(innerWidth, innerHeight);
});
</script>
</body>
</html>
